# packages/energy_core_1_3.yaml
#
# HomeAssistant 1.3 core energy flows (ha1_*)
# Clean power/flow layer rebuilt for Task 14

template:
  - sensor:
      # --------------------------------------------------
      # Raw helper conversions (canonical W units)
      # --------------------------------------------------

      - name: "HA1 Raw EV Charger W"
        unique_id: ha1_raw_ev_charger_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:ev-station"
        state: >
          {# Easee main power: usually reported in kW #}
          {% set raw = states('sensor.ehxdyl83_power') | float(0) %}
          {% set p = raw %}

          {#
            Conversion logic:
            - |p| < 0.05  → treat as 0 (noise)
            - 0.05–50     → assume kW, convert to W
            - >= 50       → already W
          #}
          {% if p | abs < 0.05 %}
            {% set p = 0 %}
          {% elif p | abs < 50 %}
            {% set p = p * 1000 %}
          {% endif %}

          {% if p < 0 %}
            0
          {% else %}
            {{ p | round(0) }}
          {% endif %}

      - name: "HA1 Raw Battery Power W"
        unique_id: ha1_raw_battery_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:battery-arrow-up"
        state: >
          {# Huawei battery: Minus = discharge, Plus = charge, usually in kW #}
          {% set raw = states('sensor.battery_charge_discharge_power') | float(0) %}
          {% set b = raw %}
          {% if b | abs < 0.05 %}
            {% set b = 0 %}
          {% elif b | abs < 50 %}
            {% set b = b * 1000 %}
          {% endif %}
          {{ b | round(0) }}

      - name: "HA1 Raw Grid Import W"
        unique_id: ha1_raw_grid_import_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:transmission-tower-import"
        state: >
          {% set raw = states('sensor.qp57qz4q_import_power') | float(0) %}
          {% set g = raw %}
          {% if g | abs < 0.05 %}
            {% set g = 0 %}
          {% elif g | abs < 50 %}
            {% set g = g * 1000 %}
          {% endif %}
          {% if g < 0 %}
            0
          {% else %}
            {{ g | round(0) }}
          {% endif %}

      - name: "HA1 Raw Grid Export W"
        unique_id: ha1_raw_grid_export_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:transmission-tower-export"
        state: >
          {% set raw = states('sensor.qp57qz4q_export_power') | float(0) %}
          {% set g = raw %}
          {% if g | abs < 0.05 %}
            {% set g = 0 %}
          {% elif g | abs < 50 %}
            {% set g = g * 1000 %}
          {% endif %}
          {% if g < 0 %}
            0
          {% else %}
            {{ g | round(0) }}
          {% endif %}

      - name: "HA1 Raw Huawei Meter W"
        unique_id: ha1_raw_huawei_meter_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:flash-triangle-outline"
        state: >
          {% set p = states('sensor.power_meter_active_power') | float(0) %}
          {{ p | round(0) }}

      - name: "HA1 Raw Inverter Power W"
        unique_id: ha1_raw_inverter_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:solar-power-variant"
        state: >
          {% set raw = states('sensor.inverter_active_power') | float(0) %}
          {% set p = raw %}
          {% if p | abs < 0.05 %}
            {% set p = 0 %}
          {% elif p | abs < 50 %}
            {% set p = p * 1000 %}
          {% endif %}
          {{ p | round(0) }}

      - name: "HA1 Raw Solar PV Input W"
        unique_id: ha1_raw_solar_pv_input_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:solar-power"
        state: >
          {% set p = states('sensor.inverter_input_power') | float(0) %}
          {% if p | abs < 1 %}
            0
          {% else %}
            {{ p | round(0) }}
          {% endif %}

      # --------------------------------------------------
      # Core HA1 power layer (all in W)
      # --------------------------------------------------

      - name: "HA1 Power Grid Total Net"
        unique_id: ha1_power_grid_total_net
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:transmission-tower"
        state: >
          {% set imp = states('sensor.ha1_raw_grid_import_w') | float(0) %}
          {% set exp = states('sensor.ha1_raw_grid_export_w') | float(0) %}
          {{ (imp - exp) | round(0) }}

      - name: "HA1 Power Battery Net"
        unique_id: ha1_power_battery_net
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:battery-arrow-up"
        state: >
          {% set b = states('sensor.ha1_raw_battery_power_w') | float(0) %}
          {{ b | round(0) }}

      - name: "HA1 Power EV Charger"
        unique_id: ha1_power_ev_charger
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:ev-station"
        state: >
          {% set ev = states('sensor.ha1_raw_ev_charger_w') | float(0) %}
          {{ ev | round(0) }}

      - name: "HA1 Power Solar AC"
        unique_id: ha1_power_solar_ac
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:solar-power"
        state: >
          {% set s = states('sensor.ha1_raw_solar_pv_input_w') | float(0) %}
          {{ s | round(0) }}

      - name: "HA1 Power House Total"
        unique_id: ha1_power_house_total
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:home"
        state: >
          {% set g  = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% set s  = states('sensor.ha1_power_solar_ac') | float(0) %}
          {% set b  = states('sensor.ha1_power_battery_net') | float(0) %}
          {% set batt_charge    = b if b > 0 else 0.0 %}
          {% set batt_discharge = -b if b < 0 else 0.0 %}
          {% set house = g + s + batt_discharge - batt_charge %}
          {{ house | round(0) }}

      - name: "HA1 Power House Core"
        unique_id: ha1_power_house_core
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:home-lightning-bolt"
        state: >
          {% set h  = states('sensor.ha1_power_house_total') | float(0) %}
          {% set ev = states('sensor.ha1_power_ev_charger') | float(0) %}
          {% set core = h - ev %}
          {% if core < 0 %}
            0
          {% else %}
            {{ core | round(0) }}
          {% endif %}

      # --------------------------------------------------
      # Simple flow layer (derived flows, W)
      # --------------------------------------------------

      - name: "HA1 Flow Grid Import"
        unique_id: ha1_flow_grid_import
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:transmission-tower-import"
        state: >
          {% set g = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% if g > 0 %}
            {{ g | round(0) }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow Grid Export"
        unique_id: ha1_flow_grid_export
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:transmission-tower-export"
        state: >
          {% set g = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% if g < 0 %}
            {{ (-g) | round(0) }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow EV Charging Power"
        unique_id: ha1_flow_ev_charging_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:ev-plug-type2"
        state: >
          {% set ev = states('sensor.ha1_power_ev_charger') | float(0) %}
          {% if ev < 0 %}
            0
          {% else %}
            {{ ev | round(0) }}
          {% endif %}

      - name: "HA1 Flow Battery Discharge"
        unique_id: ha1_flow_battery_discharge
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:battery-arrow-down"
        state: >
          {% set b = states('sensor.ha1_power_battery_net') | float(0) %}
          {% if b < 0 %}
            {{ (-b) | round(0) }}
          {% else %}
            0
          {% endif %}

      # --------------------------------------------------
      # Sanity checks (model balance + meter mismatch)
      # --------------------------------------------------

      - name: "HA1 Power Balance Error"
        unique_id: ha1_power_balance_error
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:scale-balance"
        state: >
          {% set g  = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% set s  = states('sensor.ha1_power_solar_ac') | float(0) %}
          {% set b  = states('sensor.ha1_power_battery_net') | float(0) %}
          {% set h  = states('sensor.ha1_power_house_total') | float(0) %}
          {% set batt_charge    = b if b > 0 else 0.0 %}
          {% set batt_discharge = -b if b < 0 else 0.0 %}
          {% set error = g + s + batt_discharge - batt_charge - h %}
          {{ error | round(0) }}

      - name: "HA1 Power Balance Error Abs"
        unique_id: ha1_power_balance_error_abs
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:scale-balance"
        state: >
          {% set e = states('sensor.ha1_power_balance_error') | float(0) %}
          {{ (e | abs) | round(0) }}

      - name: "HA1 Grid Meter Mismatch"
        unique_id: ha1_grid_meter_mismatch
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:scale-unbalanced"
        state: >
          {% set g_meter = states('sensor.ha1_raw_huawei_meter_w') | float(0) %}
          {% set g_model = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% set diff = g_meter - g_model %}
          {{ diff | round(0) }}

      - name: "HA1 Grid Meter Mismatch Abs"
        unique_id: ha1_grid_meter_mismatch_abs
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: "mdi:scale-unbalanced"
        state: >
          {% set d = states('sensor.ha1_grid_meter_mismatch') | float(0) %}
          {{ (d | abs) | round(0) }}
  - binary_sensor:
      - name: "HA1 Flag Power Balance Bad"
        unique_id: ha1_flag_power_balance_bad
        device_class: problem
        icon: "mdi:alert-circle"
        state: >
          {% set e = states('sensor.ha1_power_balance_error_abs') | float(0) %}
          {{ e > 500 }}

      - name: "HA1 Flag Grid Meter Mismatch"
        unique_id: ha1_flag_grid_meter_mismatch
        device_class: problem
        icon: "mdi:alert-decagram"
        state: >
          {% set d = states('sensor.ha1_grid_meter_mismatch_abs') | float(0) %}
          {{ d > 4000 }}
