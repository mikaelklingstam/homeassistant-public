template:
  - sensor:
      # --- Canonical EV charger power (kW) ---
      - name: "EV Charger Power"
        unique_id: ha13_ev_charger_power
        unit_of_measurement: "kW"
        state_class: measurement
        device_class: power
        icon: mdi:ev-station
        state: >
          {% set p = states('sensor.ehxdyl83_power') | float(0) %}
          {{ (p / 1000) | round(3) }}
        availability: >
          {{ states('sensor.ehxdyl83_power') not in ['unknown', 'unavailable', 'none'] }}

      # Raw power passthrough (W) for debugging/graphs
      - name: "EV Charger Power W"
        unique_id: ha13_ev_charger_power_w
        unit_of_measurement: "W"
        state_class: measurement
        device_class: power
        icon: mdi:ev-station
        state: "{{ states('sensor.ehxdyl83_power') | float(0) }}"
        availability: >
          {{ states('sensor.ehxdyl83_power') not in ['unknown', 'unavailable', 'none'] }}

      # Session energy (kWh)
      - name: "EV Session Energy"
        unique_id: ha13_ev_session_energy
        unit_of_measurement: "kWh"
        state_class: total_increasing
        device_class: energy
        icon: mdi:counter
        state: "{{ states('sensor.ehxdyl83_session_energy') | float(0) }}"
        availability: >
          {{ states('sensor.ehxdyl83_session_energy') not in ['unknown', 'unavailable', 'none'] }}

      # Total lifetime energy (kWh)
      - name: "EV Total Energy"
        unique_id: ha13_ev_total_energy
        unit_of_measurement: "kWh"
        state_class: total_increasing
        device_class: energy
        icon: mdi:transmission-tower-export
        state: "{{ states('sensor.ehxdyl83_lifetime_energy') | float(0) }}"
        availability: >
          {{ states('sensor.ehxdyl83_lifetime_energy') not in ['unknown', 'unavailable', 'none'] }}

      # Charger current (A)
      - name: "EV Charger Current"
        unique_id: ha13_ev_charger_current
        unit_of_measurement: "A"
        state_class: measurement
        device_class: current
        icon: mdi:current-ac
        state: "{{ states('sensor.ehxdyl83_current') | float(0) }}"
        availability: >
          {{ states('sensor.ehxdyl83_current') not in ['unknown', 'unavailable', 'none'] }}

      # Charger current limit (A)
      - name: "EV Charger Current Limit"
        unique_id: ha13_ev_charger_current_limit
        unit_of_measurement: "A"
        state_class: measurement
        device_class: current
        icon: mdi:current-ac
        state: "{{ states('sensor.ehxdyl83_max_charger_limit') | float(0) }}"
        availability: >
          {{ states('sensor.ehxdyl83_max_charger_limit') not in ['unknown', 'unavailable', 'none'] }}

      # Raw easee status (text)
      - name: "EV Charging State Raw"
        unique_id: ha13_ev_charging_state_raw
        icon: mdi:ev-station
        state: "{{ states('sensor.ehxdyl83_status') }}"
        availability: >
          {{ states('sensor.ehxdyl83_status') not in ['unknown', 'unavailable', 'none'] }}

      # Charging time left (planning input, passthrough)
      - name: "EV Charging Time Left"
        unique_id: ha13_ev_charging_time_left
        icon: mdi:timer-sand
        state: "{{ states('sensor.id4pro_charging_time_left') }}"
        availability: >
          {{ states('sensor.id4pro_charging_time_left') not in ['unknown', 'unavailable', 'none'] }}

      # EV battery SOC (%)
      - name: "EV Battery SOC"
        unique_id: ha13_ev_battery_soc
        unit_of_measurement: "%"
        state_class: measurement
        device_class: battery
        icon: mdi:car-electric
        state: "{{ states('sensor.id4pro_battery_level') | float(0) }}"
        availability: >
          {{ states('sensor.id4pro_battery_level') not in ['unknown', 'unavailable', 'none'] }}

      # EV estimated range (km)
      - name: "EV Estimated Range"
        unique_id: ha13_ev_estimated_range
        unit_of_measurement: "km"
        state_class: measurement
        icon: mdi:map-marker-distance
        state: "{{ states('sensor.id4pro_electric_range') | float(0) }}"
        availability: >
          {{ states('sensor.id4pro_electric_range') not in ['unknown', 'unavailable', 'none'] }}

      # -------------------------------------------------------------------
      # HA1 – EV: derived price level based on numeric thresholds
      # -------------------------------------------------------------------
      - name: "HA1 – EV price level"
        unique_id: ha1_ev_price_level
        icon: mdi:tag
        state: >
          {% set price = states('sensor.ha1_price_current') | float(0) %}
          {% set cheap_max     = states('input_number.ha1_ev_price_cheap_max') | float(0) %}
          {% set normal_max    = states('input_number.ha1_ev_price_normal_max') | float(0) %}
          {% set expensive_max = states('input_number.ha1_ev_price_expensive_max') | float(0) %}

          {# If thresholds are not configured properly, fall back to 'normal' #}
          {% if normal_max <= 0 %}
            normal
          {% else %}
            {% if price <= cheap_max %}
              cheap
            {% elif price <= normal_max %}
              normal
            {% elif price <= expensive_max %}
              expensive
            {% else %}
              very_expensive
            {% endif %}
          {% endif %}

      # -------------------------------------------------------------------
      # HA1 – EV: cheap hours remaining in the next 24h (from now)
      # -------------------------------------------------------------------
      - name: "HA1 – EV cheap hours remaining 24h"
        unique_id: ha1_ev_cheap_hours_remaining_24h
        unit_of_measurement: "h"
        state: >
          {% set today = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'today') %}
          {% set tomorrow = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'tomorrow') %}
          {% if today is not sequence or (today | length == 0) %}
            unknown
          {% else %}
            {% set now_hour = now().hour %}
            {% set prices = [] %}

            {# Add remaining hours of today from current hour #}
            {% for i in range(now_hour, today | length) %}
              {% set _ = prices.append(today[i]) %}
            {% endfor %}

            {# Add hours from tomorrow until we have a 24h window #}
            {% if tomorrow is sequence and (tomorrow | length > 0) %}
              {% for i in range(0, tomorrow | length) %}
                {% if prices | length >= 24 %}
                  {% break %}
                {% endif %}
                {% set _ = prices.append(tomorrow[i]) %}
              {% endfor %}
            {% endif %}

            {% if prices | length == 0 %}
              unknown
            {% else %}
              {# Simple cheap definition: below the average of this 24h window.
                 TODO: adjust this if you want "cheap" to match ha1_status_price_level logic. #}
              {% set avg = (prices | sum(0)) / (prices | length) %}
              {% set ns = namespace(remaining=0) %}
              {% for p in prices %}
                {% if p <= avg %}
                  {% set ns.remaining = ns.remaining + 1 %}
                {% endif %}
              {% endfor %}
              {{ ns.remaining }}
            {% endif %}
          {% endif %}

  - binary_sensor:
      # True when EV is actively charging (simple power-based detector)
      - name: "EV Is Charging"
        unique_id: ha13_ev_is_charging
        device_class: battery_charging
        icon: mdi:ev-station
        state: >
          {% set p = states('sensor.ehxdyl83_power') | float(0) %}
          {{ p > 100 }}
        availability: >
          {{ states('sensor.ehxdyl83_power') not in ['unknown', 'unavailable', 'none'] }}
