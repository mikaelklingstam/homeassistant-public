# packages/energy_control_1_3.yaml
#
# HomeAssistant 1.3 - Energy control layer (ha1_control_*)
# Wraps Huawei battery + Easee charger controls behind HA1 helpers and scripts.
# Helper entities for this layer live in packages/ha1_helpers_1_3.yaml.

############################################################
# Scripts – Huawei battery control
############################################################

script:
  ha1_batt_enable_grid_charge:
    alias: "HA1 – Battery: enable grid charge"
    mode: single
    sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.battery_charge_from_grid

  ha1_batt_disable_grid_charge:
    alias: "HA1 – Battery: disable grid charge"
    mode: single
    sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.battery_charge_from_grid

  ha1_batt_apply_peak_shaving_soc:
    alias: "HA1 – Battery: apply peak-shaving SOC from helper"
    mode: single
    sequence:
      - service: number.set_value
        target:
          entity_id: number.battery_peak_shaving_soc
        data:
          value: "{{ states('input_number.ha1_batt_peak_shaving_soc') | float(0) }}"

  ha1_batt_apply_grid_charge_cutoff_soc:
    alias: "HA1 – Battery: apply grid charge cutoff SOC from helper"
    mode: single
    sequence:
      - service: number.set_value
        target:
          entity_id: number.battery_grid_charge_cutoff_soc
        data:
          value: "{{ states('input_number.ha1_batt_grid_charge_cutoff_soc') | float(0) }}"

  ha1_batt_apply_grid_charge_limit:
    alias: "HA1 – Battery: apply grid charge max power from helper"
    mode: single
    sequence:
      - variables:
          peak_kw: "{{ states('input_number.ha1_batt_grid_charge_max_kw') | float(0) }}"
          # Convert kW slider to W, clamp between 0 and 2500 W (Huawei grid-charge limit)
          peak_w: >-
            {% set w = (peak_kw * 1000) | round(0) %}
            {% if w < 0 %}
              0
            {% elif w > 2500 %}
              2500
            {% else %}
              {{ w }}
            {% endif %}
      - service: number.set_value
        target:
          entity_id: number.battery_grid_charge_maximum_power
        data:
          # Huawei expects W for number.battery_grid_charge_maximum_power
          value: "{{ peak_w | int }}"

  ha1_batt_set_peak_shaving_mode:
    alias: "HA1 – Battery: set working mode to Peak Shaving"
    mode: single
    sequence:
      # NOTE: Adjust the option string below to match your actual Huawei integration.
      - service: select.select_option
        target:
          entity_id: select.battery_working_mode
        data:
          option: "Peak shaving"

############################################################
# Scripts – Easee EV charger control
############################################################

  ha1_ev_start_charging:
    alias: "HA1 – EV: start charging (Easee)"
    mode: single
    sequence:
      - variables:
          helper_value: "{{ states('input_number.ha1_ev_limit_current_a') | float(16) }}"
          amps: "{{ helper_value | round(0) | int(0) }}"
      - service: script.ha1_ev_set_charger_limit
        data:
          target_amps: "{{ amps }}"
      - service: easee.action_command
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          action_command: "start"
      - service: button.press
        target:
          entity_id: button.ehxdyl83_override_schedule

  ha1_ev_stop_charging:
    alias: "HA1 – EV: stop/pause charging (Easee)"
    mode: single
    sequence:
      - service: easee.action_command
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          action_command: "pause"

  ha1_ev_resume_charging:
    alias: "HA1 – EV: resume charging (Easee)"
    mode: single
    sequence:
      - service: easee.action_command
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          action_command: "resume"
      - service: button.press
        target:
          entity_id: button.ehxdyl83_override_schedule

  ha1_ev_pause_charging:
    alias: "HA1 – EV: pause charging (legacy alias)"
    mode: single
    sequence:
      - service: script.ha1_ev_stop_charging

  ha1_ev_override_schedule:
    alias: "HA1 – EV: override schedule"
    mode: single
    sequence:
      - service: easee.action_command
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          action_command: "override_schedule"

  ha1_ev_set_circuit_limit:
    alias: "HA1 – EV: set circuit dynamic limit (Equaliser)"
    mode: single
    fields:
      target_amps:
        description: "New per-phase circuit limit enforced by Equaliser (A)."
        example: 16
        selector:
          number:
            min: 0
            max: 40
            step: 1
            unit_of_measurement: "A"
            mode: slider
    sequence:
      - variables:
          amps: "{{ target_amps | default(0, true) | float(0) | round(0) | int(0) }}"
      - service: easee.set_circuit_dynamic_limit
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          current_p1: "{{ amps }}"
          current_p2: "{{ amps }}"
          current_p3: "{{ amps }}"

  ha1_ev_set_charger_limit:
    alias: "HA1 – EV: set charger dynamic limit (strategy)"
    mode: single
    fields:
      target_amps:
        description: "Dynamic current limit for the ID.4 charger (A)."
        example: 16
        selector:
          number:
            min: 0
            max: 32
            step: 1
            unit_of_measurement: "A"
            mode: slider
    sequence:
      - variables:
          raw_target: "{{ target_amps | default(states('input_number.ha1_ev_limit_current_a'), true) }}"
          amps: "{{ raw_target | float(0) | round(0) | int(0) }}"
      - service: easee.set_charger_dynamic_limit
        data:
          device_id: "f0e8850e90d3ff8ce4e4c2870ec4de6d"
          current: "{{ amps }}"

  ha1_ev_set_dynamic_current_from_helper:
    alias: "HA1 – EV: set dynamic current from helper"
    mode: single
    sequence:
      - service: script.ha1_ev_set_charger_limit
        data:
          target_amps: "{{ states('input_number.ha1_ev_limit_current_a') | float(0) | round(0) | int(0) }}"
