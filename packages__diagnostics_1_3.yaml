###############################################################################
# HomeAssistant 1.3 – Diagnostics & Status Layer
# File: packages/diagnostics_1_3.yaml
# Purpose:
#   - Centralize diagnostic groups for grid, solar/battery, EV, prices, peaks
#   - Provide compact system status sensors
#   - Prepare for future GUI and automation logic
###############################################################################

group:

  ###########################################################################
  # GRID DIAGNOSTICS
  ###########################################################################
  ha1_diag_grid:
    name: "HA1 – Diagnostics – Grid"
    entities:
      - sensor.ha1_import_power
      - sensor.ha1_export_power
      - sensor.ha1_net_grid_power
      - sensor.ha1_net_grid_power_kw
      - sensor.ha1_grid_status
      - sensor.ha1_import_energy_15min
      - sensor.ha1_import_energy_hourly
      - sensor.ha1_import_energy_daily
      - sensor.ha1_import_energy_monthly
      - sensor.ha1_interval_power_real
      - sensor.ha1_interval_power_cost_adjusted
      - sensor.ha1_monthly_peak_power_real
      - sensor.ha1_monthly_peak_power_cost_adjusted

  ###########################################################################
  # SOLAR & BATTERY DIAGNOSTICS
  ###########################################################################
  ha1_diag_solar_battery:
    name: "HA1 – Diagnostics – Solar & Battery"
    entities:
      - sensor.huawei_solar_input_power
      - sensor.huawei_solar_output_power
      - sensor.huawei_battery_charge_discharge_power
      - sensor.huawei_battery_soc
      - sensor.ha1_flow_solar_to_house
      - sensor.ha1_flow_solar_to_battery
      - sensor.ha1_flow_battery_to_house
      - sensor.ha1_flow_house_from_grid
      - sensor.ha1_flow_ev_from_grid

  ###########################################################################
  # EV DIAGNOSTICS
  ###########################################################################
  ha1_diag_ev:
    name: "HA1 – Diagnostics – EV & Charger"
    entities:
      - sensor.ehxdyl83_power
      - sensor.ehxdyl83_status
      - sensor.ehxdyl83_session_energy
      - sensor.ehxdyl83_lifetime_energy
      - switch.ehxdyl83_charger_enabled
      - sensor.id4pro_charging_time_left
      - binary_sensor.id4pro_charging
      - sensor.id4pro_battery_level
      - sensor.ha1_flow_ev_from_grid

  ###########################################################################
  # PRICES & PRICE HELPERS
  ###########################################################################
  ha1_diag_prices:
    name: "HA1 – Diagnostics – Prices"
    entities:
      - sensor.nordpool_kwh_se3_sek_3_10_025
      - sensor.ha1_price_current
      - sensor.ha1_price_today_avg
      - sensor.ha1_price_today_min
      - sensor.ha1_price_today_max
      - sensor.ha1_status_price_level
      - sensor.ha1_status_price_relative

  ###########################################################################
  # PEAK DIAGNOSTICS
  ###########################################################################
  ha1_diag_peaks:
    name: "HA1 – Diagnostics – Peaks & Intervals"
    entities:
      - sensor.ha1_interval_length_minutes
      - sensor.ha1_interval_energy
      - sensor.ha1_interval_power_real
      - sensor.ha1_interval_power_cost_adjusted
      - sensor.ha1_top3_peak_1
      - sensor.ha1_top3_peak_2
      - sensor.ha1_top3_peak_3
      - sensor.ha1_monthly_top3_avg_power_real
      - sensor.ha1_monthly_top3_avg_power_cost_adjusted
      - sensor.ha1_monthly_peak_power_real
      - sensor.ha1_monthly_peak_power_cost_adjusted

  ###########################################################################
  # HELPERS (MODES, OVERRIDES, SLIDERS)
  ###########################################################################
  ha1_diag_helpers:
    name: "HA1 – Diagnostics – Helpers & Controls"
    entities:
      - input_select.ha1_peak_interval_mode
      - input_number.ha1_peak_limit_kw
      - input_number.ha1_peak_warning_margin_kw
      - input_boolean.ha1_battery_automation_enabled
      - input_number.ha1_battery_min_soc_percent
      - input_number.ha1_battery_max_soc_percent
      - input_number.ha1_battery_grid_charge_max_kw
      - input_boolean.ha1_ev_automation_enabled
      - input_number.ha1_ev_min_soc_percent
      - input_number.ha1_ev_target_soc_percent
      - input_number.ha1_ev_max_charging_current
      - binary_sensor.ha1_comfort_override_active
      - input_number.ha1_comfort_override_duration_hours
      - input_datetime.ha1_comfort_override_until
      - input_boolean.ha1_force_charge_battery_now
      - input_boolean.ha1_force_charge_ev_now

  ###########################################################################
  # COMPACT SYSTEM STATUS GROUP
  ###########################################################################
  ha1_system_status:
    name: "HA1 – System Status"
    entities:
      - sensor.ha1_net_grid_power_kw
      - sensor.huawei_battery_soc
      - sensor.ehxdyl83_power
      - sensor.ha1_price_current
      - sensor.ha1_interval_power_real
      - input_boolean.ha1_peak_shaving_enabled
      - sensor.ha1_status_price_level
      - sensor.ha1_status_peak_near_limit


###############################################################################
# STATUS TEMPLATE SENSORS
# (EV + Battery status sensors added below)
# (Do not remove existing template block)
# Additional sensors appended here:
###############################################################################
template:

  - sensor:

      #######################################################################
      # EV SHORT STATE
      #######################################################################
      - name: "HA1 Status – EV State"
        unique_id: ha1_status_ev_state
        state: >
          {% set charger_power = states('sensor.ehxdyl83_power') | float(0) %}
          {% set ev_charging = is_state('binary_sensor.id4pro_charging', 'on') %}
          {% set charger_enabled = is_state('switch.ehxdyl83_charger_enabled', 'on') %}

          {% if charger_power > 100 %}
            charging
          {% elif ev_charging %}
            charging
          {% elif charger_enabled %}
            plugged in
          {% else %}
            idle
          {% endif %}

      #######################################################################
      # BATTERY SHORT STATE
      #######################################################################
      - name: "HA1 Status – Battery State"
        unique_id: ha1_status_battery_state
        state: >
          {% set p = states('sensor.huawei_battery_charge_discharge_power') | float(0) %}
          {% if p > 100 %}
            charging
          {% elif p < -100 %}
            discharging
          {% else %}
            idle
          {% endif %}

      #######################################################################
      # PRICE LEVEL (cheap / normal / expensive)
      #######################################################################
      - name: "HA1 Status – Price Level"
        unique_id: ha1_status_price_level
        state: >
          {% set p = states('sensor.ha1_price_current') | float(0) %}
          {% set avg = states('sensor.ha1_price_today_avg') | float(0) %}
          {% if p <= avg * 0.75 %}
            cheap
          {% elif p >= avg * 1.25 %}
            expensive
          {% else %}
            normal
          {% endif %}

      #######################################################################
      # PRICE RELATIVE (% difference vs today’s avg)
      #######################################################################
      - name: "HA1 Status – Price Relative"
        unique_id: ha1_status_price_relative
        unit_of_measurement: "%"
        state: >
          {% set p = states('sensor.ha1_price_current') | float(0) %}
          {% set avg = states('sensor.ha1_price_today_avg') | float(0) %}
          {% if avg == 0 %}
            0
          {% else %}
            {{ ((p - avg) / avg) * 100 | round(1) }}
          {% endif %}

  - binary_sensor:

      #######################################################################
      # PEAK NEAR LIMIT (boolean)
      #######################################################################
      - name: "HA1 Status – Peak Near Limit"
        unique_id: ha1_status_peak_near_limit
        device_class: problem
        state: >
          {% set p = states('sensor.ha1_interval_power_real') | float(0) %}
          {% set limit = states('input_number.ha1_peak_limit_kw') | float(0) %}
          {% set margin = states('input_number.ha1_peak_warning_margin_kw') | float(0) %}
          {{ p >= (limit - margin) }}

      #######################################################################
      # COMFORT OVERRIDE ACTIVE (boolean)
      #######################################################################
      - name: "HA1 Comfort Override Active"
        unique_id: ha1_comfort_override_active
        device_class: safety
        state: >
          {% set enabled = is_state('input_boolean.ha1_comfort_override_enabled', 'on') %}
          {% set until_ts = as_timestamp(states('input_datetime.ha1_comfort_override_until')) %}
          {% set valid_until = until_ts is not none and until_ts > 0 %}
          {% if enabled %}
            {% if valid_until %}
              {{ now().timestamp() < until_ts }}
            {% else %}
              true
            {% endif %}
          {% else %}
            false
          {% endif %}
        attributes:
          expires_at: "{{ states('input_datetime.ha1_comfort_override_until') }}"
          reason: >
            {% if is_state('input_boolean.ha1_comfort_override_enabled', 'on') %}
              Comfort override toggle is on{% if states('input_datetime.ha1_comfort_override_until') not in ['unknown','unavailable',''] %}, until {{ states('input_datetime.ha1_comfort_override_until') }}{% endif %}.
            {% else %}
              Inactive
            {% endif %}
