###############################################################################
# HomeAssistant 1.3 â€“ HA1 Compatibility Layer
# File: packages/ha1_compat_1_3.yaml
#
# Purpose:
#   - Provide missing ha1_* sensors that dashboards/diagnostics expect
#   - Mostly as aliases/passthroughs to existing canonical sensors
#   - Avoid "entity not found" spam without changing existing logic
###############################################################################

template:
  - sensor:

      #######################################################################
      # GRID IMPORT / EXPORT / NET POWER (aliases)
      #######################################################################
      - name: "HA1 Import Power"
        unique_id: ha1_import_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_import') | float(0) }}

      - name: "HA1 Export Power"
        unique_id: ha1_export_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_export') | float(0) }}

      - name: "HA1 Net Grid Power"
        unique_id: ha1_net_grid_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_grid_total_net') | float(0) }}

      - name: "HA1 Net Grid Power kW"
        unique_id: ha1_net_grid_power_kw
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ (states('sensor.ha1_power_grid_total_net') | float(0) / 1000) | round(3) }}

      #######################################################################
      # GRID IMPORT ENERGY (aliases to utility meters)
      #######################################################################
      - name: "HA1 Import Energy 15min"
        unique_id: ha1_import_energy_15min
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {{ states('sensor.ha1_grid_import_energy_quarter_hour') | float(0) }}

      - name: "HA1 Import Energy Hourly"
        unique_id: ha1_import_energy_hourly
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {{ states('sensor.ha1_grid_import_energy_hourly') | float(0) }}

      - name: "HA1 Import Energy Daily"
        unique_id: ha1_import_energy_daily
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {{ states('sensor.ha1_grid_import_energy_daily') | float(0) }}

      - name: "HA1 Import Energy Monthly"
        unique_id: ha1_import_energy_monthly
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {{ states('sensor.ha1_grid_import_energy_monthly') | float(0) }}

      #######################################################################
      # INTERVAL METRICS (bridging to peak package)
      #######################################################################
      - name: "HA1 Interval Energy"
        unique_id: ha1_interval_energy
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {{ states('sensor.ha1_import_energy_current_interval') | float(0) }}

      - name: "HA1 Interval Length Minutes"
        unique_id: ha1_interval_length_minutes
        unit_of_measurement: "min"
        state: >
          {{ (states('sensor.ha1_peak_interval_length_hours') | float(0) * 60) | round(0) }}

      - name: "HA1 Interval Power Real"
        unique_id: ha1_interval_power_real
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('sensor.ha1_peak_power_interval_real') | float(0) }}

      - name: "HA1 Interval Power Cost Adjusted"
        unique_id: ha1_interval_power_cost_adjusted
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('sensor.ha1_peak_power_interval_cost_adjusted') | float(0) }}

      #######################################################################
      # MONTHLY PEAKS & TOP-3 (bridges)
      #######################################################################
      - name: "HA1 Top3 Peak 1"
        unique_id: ha1_top3_peak_1
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('input_number.ha1_month_peak_top1_kw') | float(0) }}

      - name: "HA1 Top3 Peak 2"
        unique_id: ha1_top3_peak_2
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('input_number.ha1_month_peak_top2_kw') | float(0) }}

      - name: "HA1 Top3 Peak 3"
        unique_id: ha1_top3_peak_3
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('input_number.ha1_month_peak_top3_kw') | float(0) }}

      - name: "HA1 Monthly Top3 Avg Power Real"
        unique_id: ha1_monthly_top3_avg_power_real
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {% set p1 = states('input_number.ha1_month_peak_top1_kw') | float(0) %}
          {% set p2 = states('input_number.ha1_month_peak_top2_kw') | float(0) %}
          {% set p3 = states('input_number.ha1_month_peak_top3_kw') | float(0) %}
          {{ ((p1 + p2 + p3) / 3) | round(3) }}

      - name: "HA1 Monthly Top3 Avg Power Cost Adjusted"
        unique_id: ha1_monthly_top3_avg_power_cost_adjusted
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {% set avg_real = ((
            states('input_number.ha1_month_peak_top1_kw') | float(0) +
            states('input_number.ha1_month_peak_top2_kw') | float(0) +
            states('input_number.ha1_month_peak_top3_kw') | float(0)
          ) / 3) %}
          {% set factor = states('sensor.ha1_peak_billing_factor') | float(1) %}
          {{ (avg_real * factor) | round(3) }}

      - name: "HA1 Monthly Peak Power Cost Adjusted"
        unique_id: ha1_monthly_peak_power_cost_adjusted
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('sensor.ha1_monthly_peak_power_cost_adjusted_top3') | float(0) }}

      - name: "HA1 Monthly Peak Power Real History Max"
        unique_id: ha1_monthly_peak_power_real_history_max
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {{ states('sensor.ha1_monthly_peak_power_real') | float(0) }}

      #######################################################################
      # FLOW ALIASES / "AVERAGE" PASSTHROUGHS
      #######################################################################
      - name: "HA1 Flow EV From Grid"
        unique_id: ha1_flow_ev_from_grid
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_ev_charging_power') | float(0) }}

      - name: "HA1 Flow House From Grid"
        unique_id: ha1_flow_house_from_grid
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_house_total') | float(0) }}

      - name: "HA1 Flow Grid Import Avg 1m"
        unique_id: ha1_flow_grid_import_avg_1m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_import') | float(0) }}

      - name: "HA1 Flow Grid Import Avg 5m"
        unique_id: ha1_flow_grid_import_avg_5m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_import') | float(0) }}

      - name: "HA1 Flow Grid Export Avg 1m"
        unique_id: ha1_flow_grid_export_avg_1m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_export') | float(0) }}

      - name: "HA1 Flow Grid Export Avg 5m"
        unique_id: ha1_flow_grid_export_avg_5m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_flow_grid_export') | float(0) }}

      - name: "HA1 Power EV Charger Avg 1m"
        unique_id: ha1_power_ev_charger_avg_1m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_ev_charger') | float(0) }}

      - name: "HA1 Power Grid Net Avg 1m"
        unique_id: ha1_power_grid_net_avg_1m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_grid_total_net') | float(0) }}

      - name: "HA1 Power Grid Net Avg 5m"
        unique_id: ha1_power_grid_net_avg_5m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_grid_total_net') | float(0) }}

      - name: "HA1 Power House Total Avg 1m"
        unique_id: ha1_power_house_total_avg_1m
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_power_house_total') | float(0) }}

      #######################################################################
      # GRID STATUS (simple import/export/neutral state)
      #######################################################################
      - name: "HA1 Grid Status"
        unique_id: ha1_grid_status
        state: >
          {% set p = states('sensor.ha1_power_grid_total_net') | float(0) %}
          {% if p > 100 %}
            import
          {% elif p < -100 %}
            export
          {% else %}
            neutral
          {% endif %}

      #######################################################################
      # HUAWEI RAW-LIKE ALIASES (using ha1_huawei_* sensors)
      #######################################################################
      - name: "Huawei Solar Input Power"
        unique_id: huawei_solar_input_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_huawei_solar_power') | float(0) }}

      - name: "Huawei Solar Output Power"
        unique_id: huawei_solar_output_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_huawei_solar_power') | float(0) }}

      - name: "Huawei Battery Charge/Discharge Power"
        unique_id: huawei_battery_charge_discharge_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {{ states('sensor.ha1_huawei_battery_power') | float(0) }}

      - name: "Huawei Battery SOC"
        unique_id: huawei_battery_soc
        unit_of_measurement: "%"
        device_class: battery
        state: >
          {{ states('sensor.ha1_huawei_battery_soc') | float(0) }}
