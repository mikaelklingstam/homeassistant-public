title: Energy Flow 1.2
views:
  - title: Energy Flow
    path: energy_flow
    panel: true
    theme: Mushroom
    background:
      image: /local/energy/energy_house_v1.png
      opacity: 20
      alignment: center
      size: cover
      repeat: no-repeat
      attachment: scroll

    cards:
      - type: picture-elements
        image: /local/energy/energy_house_v1.png
        elements:

          ####################################################
          # SOLAR PANEL – POWER TILE (your position)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_solar_power
            name: Solar
            icon: mdi:solar-power
            style:
              top: 15%
              left: 20%
              width: 12%
            show_state: true
            show_units: true
            tap_action:
              action: more-info
            custom_fields:
              power: >
                [[[ return (entity.state !== "unavailable") ? entity.state + " W" : "—"; ]]]
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

          ####################################################
          # BATTERY – SOC + POWER (your position)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_battery_soc
            name: Battery
            icon: mdi:battery-high
            style:
              top: 82%
              left: 18%
              width: 12%
            show_state: true
            show_units: true
            custom_fields:
              soc: '[[[ return entity.state + " %"; ]]]'
              power: >
                [[[
                  const p = states["sensor.ha1_battery_power"]?.state;
                  if (!p || p === "unavailable") return "— W";
                  return p + " W";
                ]]]
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i soc" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                soc:
                  - font-size: 11px
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

          ####################################################
          # HOUSE CONSUMPTION (your position)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_house_power
            name: House
            icon: mdi:home-lightning-bolt
            style:
              top: 50%
              left: 20%
              width: 12%
            show_state: true
            show_units: true
            custom_fields:
              power: '[[[ return entity.state + " W"; ]]]'
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

          ####################################################
          # EV CHARGER (your position)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_ev_charger_power
            name: EV Charger
            icon: mdi:ev-station
            style:
              top: 60%
              left: 55%
              width: 12%
            show_state: true
            show_units: true
            custom_fields:
              power: '[[[ return entity.state + " W"; ]]]'
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

          ####################################################
          # ID.4 – CAR NODE (new, near EV)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_ev_id4_battery_level
            name: ID.4
            icon: mdi:car-electric
            style:
              top: 70%
              left: 93%
              width: 12%
            show_state: true
            show_units: true
            tap_action:
              action: more-info
            custom_fields:
              power: '[[[ return entity.state + " %"; ]]]'
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

           ####################################################
          # GRID / METER
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_grid_power
            name: Grid
            icon: mdi:transmission-tower
            style:
              top: 85%
              left: 80%
              width: 14%
            show_state: true
            show_units: true
            custom_fields:
              power: >
                [[[
                  const v = parseFloat(entity.state);
                  if (isNaN(v)) return "—";
                  // Negative = import from grid, positive = export to grid
                  const dir = v < 0 ? "Import" : (v > 0 ? "Export" : "Idle");
                  return dir + " " + Math.abs(v).toFixed(0) + " W";
                ]]]
            styles:
              card:
                - border-radius: 18px
                - padding: 8px
                - box-shadow: 0 0 10px rgba(0,0,0,0.45)
                - font-size: 12px
              grid:
                - grid-template-areas: '"i n" "i power"'
                - grid-template-columns: 28px auto
              custom_fields:
                power:
                  - font-size: 11px
                  - opacity: 0.8
              name:
                - justify-self: start
              icon:
                - size: 22px

          ####################################################
          # FLOW – SOLAR → BATTERY (vertical alignment with Solar & Battery)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_flow_solar_to_battery
            name: ''
            icon: mdi:arrow-down
            style:
              top: 48%
              left: 20%
              width: 4%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 4px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%) rotate(90deg)
                - background: >
                    [[[
                      const v = parseFloat(entity.state);
                      if (isNaN(v) || v <= 0) return "rgba(120,120,120,0.4)";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,255,0,0.9))";
                    ]]]
              icon:
                - display: none

          ####################################################
          # FLOW – BATTERY → HOUSE (vertical alignment with Battery & House)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_flow_battery_to_house
            name: ''
            icon: mdi:arrow-down
            style:
              top: 66%
              left: 20%
              width: 4%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 8px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%) rotate(90deg)
                - background: >
                    [[[
                      const v = parseFloat(entity.state);
                      if (isNaN(v) || v <= 0) return "rgba(120,120,120,0.4)";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,150,255,0.9))";
                    ]]]
              icon:
                - display: none

          ####################################################
          # FLOW – BATTERY → GRID (new AC split)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_flow_battery_to_grid_ac
            name: ''
            icon: mdi:arrow-right
            style:
              top: 83%
              left: 50%
              width: 65%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 4px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%)
                - background: >
                    [[[
                      const v = Number(entity.state) || 0;
                      if (v <= 0) return "rgba(120,120,120,0.4)";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,200,0,0.9))";
                    ]]]
              icon:
                - display: none

          ####################################################
          # FLOW – SOLAR → HOUSE (aligned with Solar → House vertical stack)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_flow_solar_to_house
            name: ''
            icon: mdi:arrow-down
            style:
              top: 32%
              left: 20%
              width: 4%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 4px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%) rotate(90deg)
                - background: >
                    [[[
                      const v = parseFloat(entity.state);
                      if (isNaN(v) || v <= 0) return "rgba(120,120,120,0.4)";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,165,0,0.9))";
                    ]]]
              icon:
                - display: none

          ####################################################
          # FLOW ARROWS – GRID ↔ HOUSE (IMPORT/EXPORT)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_grid_power   # same as grid tile; sign decides color
            name: ''
            icon: mdi:arrow-right
            style:
              top: 50%
              left: 65%
              width: 20%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 4px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%)
                - background: >
                    [[[
                      const v = parseFloat(entity.state);
                      if (isNaN(v) || v === 0) return "rgba(120,120,120,0.4)";
                      // Negative = import (blue), positive = export (green)
                      if (v < 0) return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,150,255,0.95))";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,255,0,0.95))";
                    ]]]
              icon:
                - display: none

          ####################################################
          # FLOW – HOUSE → EV CHARGER (horizontal alignment between House & EV)
          ####################################################
          - type: custom:button-card
            entity: sensor.ha1_flow_house_to_ev
            name: ''
            icon: mdi:arrow-right
            style:
              top: 60%
              left: 37%
              width: 40%
            show_name: false
            show_state: false
            styles:
              card:
                - border-radius: 999px
                - height: 4px
                - box-shadow: none
                - padding: 0px
                - transform: translate(-50%, -50%)
                - background: >
                    [[[
                      const v = parseFloat(entity.state);
                      if (isNaN(v) || v <= 0) return "rgba(120,120,120,0.4)";
                      return "linear-gradient(90deg, rgba(255,255,255,0.2), rgba(0,150,255,0.9))";
                    ]]]
              icon:
                - display: none

