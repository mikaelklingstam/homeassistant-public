title: HA1 Debug
icon: mdi:test-tube

views:
  - title: HA1 Debug
    path: ha1-debug
    icon: mdi:test-tube
    panel: true
    cards:
      - type: vertical-stack
        cards:

          - type: markdown
            content: |
              # üß™ HA1.3 Debug Dashboard
              Live monitoring of Task 14 template sensors ‚Äî raw powers, HA1 power layer, flows and sanity checks.

          # Key snapshot (HA1 power layer)
          - type: entities
            title: üîå Key Snapshot (HA1 Power Layer)
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_power_grid_total_net
                name: Grid Total (net, +import)
              - entity: sensor.ha1_power_solar_ac
                name: Solar AC (PV)
              - entity: sensor.ha1_power_battery_net
                name: Battery Net (+charge / -discharge)
              - entity: sensor.ha1_power_ev_charger
                name: EV Charger Power
              - entity: sensor.ha1_power_house_core
                name: House Core (no EV)
              - entity: sensor.ha1_power_house_total
                name: House Total (incl. EV)

          # Raw sensors
          - type: entities
            title: üîé Key Snapshot Raw Sensors
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_raw_grid_import_w
                name: Grid Import (Easee)
              - entity: sensor.ha1_raw_grid_export_w
                name: Grid Export (Easee)
              - entity: sensor.ha1_raw_ev_charger_w
                name: Easee Charger (raw)
              - entity: sensor.ha1_raw_battery_power_w
                name: Battery Charge/Discharge (raw)
              - entity: sensor.ha1_raw_solar_pv_input_w
                name: Inverter Input Power (PV)
              - entity: sensor.ha1_raw_huawei_meter_w
                name: Huawei Power Meter (diagnostic)

          # Power layer (final values)
          - type: entities
            title: ‚ö° Power Layer (ha1_power_*)
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_power_grid_total_net
                name: Grid Net (Total)
              - entity: sensor.ha1_power_solar_ac
                name: Solar AC
              - entity: sensor.ha1_power_battery_net
                name: Battery Net
              - entity: sensor.ha1_power_ev_charger
                name: EV Charger Power
              - entity: sensor.ha1_power_house_core
                name: House Core
              - entity: sensor.ha1_power_house_total
                name: House Total

          # Flow layer
          - type: entities
            title: üîÄ Flow Layer (ha1_flow_*)
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_flow_grid_import
                name: Grid Import
              - entity: sensor.ha1_flow_grid_export
                name: Grid Export
              - entity: sensor.ha1_flow_ev_charging_power
                name: EV Charging Power
              - entity: sensor.ha1_flow_battery_discharge
                name: Battery Discharge

          # Sanity check section
          - type: markdown
            content: |
              ## üß© Sanity Checks
              **Model balance** uses the HA1-normalised powers > grid_total, solar, battery, house_total.  
              **Grid meter mismatch** compares the Huawei meter against the modelled grid power.

          # Model balance
          - type: entities
            title: Model Balance
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_power_balance_error
                name: Model Balance Error (W)
              - entity: sensor.ha1_power_balance_error_abs
                name: Model Balance Error Absolute (W)
              - entity: binary_sensor.ha1_flag_power_balance_bad
                name: Model Balance Problem?

          # Grid meter mismatch
          - type: entities
            title: Grid Meter Mismatch
            show_header_toggle: false
            entities:
              - entity: sensor.ha1_grid_meter_mismatch
                name: Meter Minus Model (W)
              - entity: sensor.ha1_grid_meter_mismatch_abs
                name: Meter Minus Model Absolute (W)
              - entity: binary_sensor.ha1_flag_grid_meter_mismatch
                name: Grid Meter Mismatch?

          # Core power trends (short window)
          - type: history-graph
            title: üìà Core Powers ‚Äì last 1 hour
            hours_to_show: 1
            refresh_interval: 30
            entities:
              - entity: sensor.ha1_power_grid_total_net
                name: Grid Net (+import / -export)
              - entity: sensor.ha1_power_solar_ac
                name: Solar AC
              - entity: sensor.ha1_power_battery_net
                name: Battery Net (+charge / -discharge)
              - entity: sensor.ha1_power_ev_charger
                name: EV Charger
              - entity: sensor.ha1_power_house_total
                name: House Total

          # Flows & sanity trends (longer window)
          - type: history-graph
            title: üìä Flows & Balance ‚Äì last 24 hours
            hours_to_show: 24
            refresh_interval: 60
            entities:
              - entity: sensor.ha1_flow_grid_import
                name: Grid Import
              - entity: sensor.ha1_flow_grid_export
                name: Grid Export
              - entity: sensor.ha1_flow_ev_charging_power
                name: EV Charging Power
              - entity: sensor.ha1_flow_battery_discharge
                name: Battery Discharge
              - entity: sensor.ha1_power_balance_error_abs
                name: Model Balance Error |abs|

          # Control tools ‚Äì master switches & knobs
          - type: entities
            title: ‚öôÔ∏è Control Tools ‚Äì Master Toggles & Targets
            show_header_toggle: false
            entities:
              - entity: input_boolean.ha1_control_ev_auto
                name: EV Charging ‚Äì automation enabled
              - entity: input_boolean.ha1_control_battery_auto
                name: Battery Optimization ‚Äì automation enabled
              - type: divider
              - entity: input_number.ha1_ev_limit_current_a
                name: EV Max Current (A)
              - entity: input_number.ha1_batt_grid_charge_max_kw
                name: Battery Grid Charge Max (kW)
              - entity: input_number.ha1_batt_peak_shaving_soc
                name: Battery Peak-Shaving Target SOC (%)
              - entity: input_number.ha1_batt_grid_charge_cutoff_soc
                name: Battery Grid Charge Cutoff SOC (%)

          # Control tools ‚Äì EV scripts
          - type: entities
            title: üöó EV Control ‚Äì Scripts
            show_header_toggle: false
            entities:
              - entity: script.ha1_ev_start_charging
                name: Start EV Charging
              - entity: script.ha1_ev_stop_charging
                name: Stop EV Charging
              - entity: script.ha1_ev_pause_charging
                name: Pause EV Charging
              - entity: script.ha1_ev_resume_charging
                name: Resume EV Charging
              - entity: script.ha1_ev_override_schedule
                name: Override Schedule
              - entity: script.ha1_ev_set_dynamic_current_from_helper
                name: Apply EV Dynamic Current from Helper

          # Control tools ‚Äì Battery scripts
          - type: entities
            title: üîã Battery Control ‚Äì Scripts
            show_header_toggle: false
            entities:
              - entity: script.ha1_batt_enable_grid_charge
                name: Enable Grid Charge
              - entity: script.ha1_batt_disable_grid_charge
                name: Disable Grid Charge
              - type: divider
              - entity: script.ha1_batt_apply_peak_shaving_soc
                name: Apply Peak-Shaving SOC from Helper
              - entity: script.ha1_batt_apply_grid_charge_cutoff_soc
                name: Apply Grid Charge Cutoff SOC from Helper
              - entity: script.ha1_batt_apply_grid_charge_limit
                name: Apply Grid Charge Max (kW) from Helper
              - entity: script.ha1_batt_set_peak_shaving_mode
                name: Set Working Mode = Peak Shaving

  - title: HA1 Status
    path: ha1-status
    icon: mdi:clipboard-pulse
    cards:
      - type: markdown
        content: |
          # üìã HA1 System Status
          Task 18 snapshot of HA1.3 core sensors, peak trackers and helper overrides.

      - type: entities
        title: ‚ö° Core Power & Flow
        show_header_toggle: false
        entities:
          - entity: sensor.ha1_power_consumption_total_kw
            name: House Total Load (kW)
          - entity: sensor.ha1_power_consumption_core_kw
            name: House Core Load (kW)
          - entity: sensor.ha1_power_net_load_kw
            name: Grid Net Load (kW)
          - type: divider
          - entity: sensor.ha1_flow_grid_import
            name: Grid Import (W)
          - entity: sensor.ha1_flow_grid_export
            name: Grid Export (W)
          - entity: sensor.ha1_flow_ev_charging_power
            name: EV Charging Flow (W)
          # - entity: sensor.ha1_ev_share_of_house_load_pct
          #   name: EV Share of House Load (%)  # TODO: reintroduce EV share metric in energy_metrics_1_3.yaml
          - entity: sensor.ha1_power_balance_error_abs
            name: Model Balance Error (W)
          - entity: binary_sensor.ha1_flag_power_balance_bad
            name: Model Balance Problem?

      - type: entities
        title: üîã Huawei Solar & Battery
        show_header_toggle: false
        entities:
          - entity: sensor.ha1_huawei_solar_power
            name: Huawei Solar Power (kW)
          - entity: sensor.ha1_huawei_grid_power
            name: Huawei Grid Power (kW)
          - entity: sensor.ha1_huawei_battery_power
            name: Huawei Battery Power (kW)
          - entity: sensor.ha1_huawei_battery_soc
            name: Huawei Battery SOC (%)
          - entity: binary_sensor.ha1_huawei_battery_charging
            name: Battery Charging?
          - entity: binary_sensor.ha1_huawei_battery_discharging
            name: Battery Discharging?
          - type: divider
          - entity: sensor.ha1_huawei_solar_energy_today
            name: Solar Energy Today (kWh)
          - entity: sensor.ha1_huawei_battery_energy_charged_today
            name: Battery Charged Today (kWh)
          - entity: sensor.ha1_huawei_battery_energy_discharged_today
            name: Battery Discharged Today (kWh)
          - type: divider
          - entity: number.battery_grid_charge_maximum_power
            name: Grid Charge Limit (W)
          - entity: number.battery_maximum_charging_power
            name: Total Charge Limit (W)
          - entity: input_boolean.ha1_battery_allow_grid_charge
            name: Allow Grid Charge
          - entity: input_boolean.ha1_battery_peak_support_enabled
            name: Peak Support Enabled

      - type: entities
        title: üöó EV Charger & Vehicle
        show_header_toggle: false
        entities:
          - entity: binary_sensor.ev_is_charging
            name: EV Charging?
          - entity: sensor.ev_charger_power
            name: EV Charger Power (kW)
          - entity: sensor.ev_charger_power_w
            name: EV Charger Power (W)
          - entity: sensor.ev_charger_current
            name: Charger Current (A)
          - entity: sensor.ev_charger_current_limit
            name: Charger Current Limit (A)
          - type: divider
          - entity: sensor.ev_session_energy
            name: Session Energy (kWh)
          - entity: sensor.ev_charging_time_left
            name: Charging Time Left
          - entity: sensor.ev_battery_soc
            name: EV Battery SOC (%)
          - entity: sensor.ev_estimated_range
            name: EV Estimated Range (km)
          - type: divider
          - entity: input_number.ha1_ev_limit_current_a
            name: EV Current Limit Helper (A)
          - entity: input_boolean.ha1_force_ev_charge_now
            name: Force Charge Now
          - entity: input_boolean.ha1_control_ev_auto
            name: EV Automations Enabled
          - entity: input_boolean.ha1_ev_obey_peak_limit
            name: Obey Peak Limit

      - type: entities
        title: üìà Peak & Utility Summary
        show_header_toggle: false
        entities:
          - entity: sensor.ha1_peak_billable_power_kw
            name: Peak Billable Power (kW)
          - entity: sensor.ha1_peak_power_interval_cost_adjusted
            name: Peak Interval (Cost-Adjusted)
          - entity: sensor.ha1_peak_power_interval_real
            name: Peak Interval (Real)
          - entity: sensor.ha1_monthly_peak_power_real_history_max
            name: Monthly Peak (Real)
          - entity: sensor.ha1_monthly_peak_power_cost_adjusted_top3
            name: Monthly Peak (Billable Top3)  # TODO: ensure entity slug matches template after HA reload
          - entity: sensor.ha1_monthly_peak_cost_estimated
            name: Monthly Peak Cost (SEK)
          - type: divider
          - entity: sensor.ha1_grid_import_energy_daily
            name: Grid Import Daily (kWh)
          - entity: sensor.ha1_grid_import_energy_monthly
            name: Grid Import Monthly (kWh)
          - entity: sensor.ha1_grid_export_energy_daily
            name: Grid Export Daily (kWh)
          - entity: sensor.ha1_grid_export_energy_monthly
            name: Grid Export Monthly (kWh)
          - type: divider
          - entity: input_number.ha1_daily_peak_power_cost_adjusted
            name: Daily Peak (Helper)
          - entity: input_number.ha1_peak_limit_kw
            name: Peak Limit (kW)
          - entity: input_number.ha1_peak_warning_kw
            name: Peak Warning (kW)
          - entity: input_select.ha1_peak_interval_mode
            name: Peak Interval Length
          - entity: input_number.ha1_month_peak_top1_kw
            name: Month Peak #1
          - entity: input_number.ha1_month_peak_top2_kw
            name: Month Peak #2
          - entity: input_number.ha1_month_peak_top3_kw
            name: Month Peak #3
          - entity: input_number.ha1_peak_tariff_price_per_kw
            name: Peak Tariff Price (SEK/kW)
          - entity: input_text.ha1_peak_tariff_agreement_name
            name: Tariff Agreement Name

      - type: entities
        title: üéõÔ∏è System Helpers & Overrides
        show_header_toggle: false
        entities:
          - entity: input_boolean.ha1_automation_master_enabled
            name: Master Automation Enable
          - entity: input_boolean.ha1_peak_shaving_enabled
            name: Peak Shaving Enabled
          - entity: input_boolean.ha1_control_battery_auto
            name: Battery Automations Enabled
          - entity: input_boolean.ha1_control_ev_auto
            name: EV Automations Enabled
          - entity: input_boolean.ha1_battery_allow_grid_charge
            name: Allow Grid Charge
          - entity: input_boolean.ha1_battery_peak_support_enabled
            name: Battery Peak Support
          - entity: input_boolean.ha1_force_battery_charge_from_grid_now
            name: Force Battery Grid Charge Now
          - entity: input_boolean.ha1_force_ev_charge_now
            name: Force EV Charge Now
          - entity: input_boolean.ha1_comfort_override_enabled
            name: Comfort Override Enabled
          - entity: input_boolean.ha1_allow_high_price_heating
            name: Allow High-Price Heating
          - entity: input_boolean.ha1_debug_energy_logic
            name: Debug Energy Logic
          - entity: input_boolean.ha1_debug_notifications_enabled
            name: Debug Notifications Enabled
          - entity: input_boolean.ha1_debug_freeze_optimizers
            name: Freeze Optimizers
          - type: divider
          - entity: input_number.ha1_battery_min_soc_normal
            name: Battery Min SOC (Normal)
          - entity: input_number.ha1_battery_max_soc_target
            name: Battery Max SOC Target
          - entity: input_number.ha1_batt_peak_shaving_soc
            name: Battery Peak Shaving SOC
          - entity: input_number.ha1_batt_grid_charge_cutoff_soc
            name: Battery Grid Charge Cutoff SOC
          - entity: input_number.ha1_batt_grid_charge_max_kw
            name: Battery Grid Charge Max (kW)
