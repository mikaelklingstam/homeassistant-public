# --- HomeAssistant 1.3 – User-Facing Energy Overview ---
# File: dashboards/ha1_energy_overview.yaml
# Dashboard: HA1 – Energy Overview  (id: ha1-energy-overview)
#
# Purpose:
# Clean, user-facing daily driver view for energy status and basic controls.
# Shows: Solar → Battery → House → EV → Grid, plus price, peaks, overrides.

title: "HA1 – Energy Overview"

views:
  - title: "HA1 – Energy Overview"
    path: ha1-energy-overview
    icon: mdi:home-battery
    type: masonry

    cards:

      # --- HA1 – Energy Overview: Status & price strip ----------------------
      - type: glance
        title: "Status"
        entities:
          - entity: sensor.ha1_net_grid_power
            name: Net grid
          - entity: input_boolean.ha1_automations_master_enable
            name: Automations
          - entity: input_boolean.ha1_peak_shaving_enabled
            name: Peak shaving
          - entity: input_boolean.ha1_comfort_override_enabled
            name: Comfort

      - type: glance
        title: "Price & peak"
        entities:
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Nordpool
          - entity: sensor.ha1_status_price_level
            name: Price level
          - entity: sensor.ha1_monthly_peak_power_cost_adjusted
            name: Peak (adjusted)

      # --- HA1 – Energy Overview: Flows & core metrics ----------------------
      - type: entities
        title: "Energy flows – Solar → Battery → House → EV → Grid"
        show_header_toggle: false
        entities:
          - entity: sensor.ha1_power_solar_ac
            name: Solar production (AC)
          - entity: sensor.ha1_power_battery_net
            name: Battery power (net)
          - entity: sensor.ha1_huawei_battery_soc
            name: Battery state of charge
          - entity: sensor.ha1_power_house_total
            name: House consumption
          - entity: sensor.ha1_power_ev_charger
            name: EV charging power
          - entity: sensor.ha1_net_grid_power
            name: Net grid import/export

      - type: glance
        title: "Flows snapshot"
        entities:
          - entity: sensor.ha1_power_solar_ac
            name: Solar
          - entity: sensor.ha1_power_battery_net
            name: Battery
          - entity: sensor.ha1_power_ev_charger
            name: EV
          - entity: sensor.ha1_net_grid_power
            name: Grid

      # --- HA1 – Energy Overview: EV panel ----------------------------------
      - type: entities
        title: "EV – Charging & Mode"
        show_header_toggle: false
        entities:
          - entity: input_select.ha1_ev_charging_mode
            name: EV charging mode
          - entity: switch.ehxdyl83_charger_enabled
            name: Charger output (Easee)
          - entity: sensor.ha1_power_ev_charger
            name: EV charger power
          - entity: sensor.ev_charging_time_left   # sensor.id4pro_charging_time_left
            name: ID.4 – time left

          # EV battery SOC (alias of ID.4 level):
          - entity: sensor.ev_battery_soc
            name: EV battery SOC

          # EV charging limit (kW):
          - entity: input_number.ha1_ev_max_charging_power_kw
            name: EV charging limit (kW)

          # Derived EV max current (A) from conversion package:
          - entity: sensor.ha1_ev_max_charging_current_2
            name: EV max current (A)

      # --- HA1 – Energy Overview: Battery panel -----------------------------
      - type: entities
        title: "Battery – SOC, power & grid charge"
        show_header_toggle: false
        entities:
          - entity: sensor.ha1_huawei_battery_soc
            name: Battery state of charge
          - entity: sensor.ha1_power_battery_net
            name: Battery power (net)
          - entity: input_number.ha1_battery_grid_charge_limit_kw
            name: Max grid charge power (kW)
          - entity: input_number.ha1_battery_min_soc_normal
            name: Min SOC – normal mode
          - entity: input_number.ha1_batt_peak_shaving_soc
            name: Min SOC – peak mode

      # --- HA1 – Energy Overview: Peaks & cost ------------------------------
      - type: entities
        title: "Peaks & cost"
        show_header_toggle: false
        entities:
          - entity: input_number.ha1_peak_limit_kw
            name: Monthly peak limit (kW)
          - entity: input_number.ha1_peak_warning_kw
            name: Peak warning (kW)
          - entity: input_number.ha1_peak_warning_margin_kw
            name: Peak warning margin (kW)
          - entity: sensor.ha1_monthly_peak_power_real_history_max_2
            name: Current monthly peak (raw)
          - entity: sensor.ha1_monthly_peak_power_cost_adjusted
            name: Monthly peak (cost-adjusted)

      # --- HA1 – Energy Overview: Mini history ------------------------------
      - type: history-graph
        title: "History – Net grid, price & battery SOC"
        hours_to_show: 4
        refresh_interval: 60
        entities:
          - entity: sensor.ha1_net_grid_power
            name: Net grid power
          - entity: sensor.nordpool_kwh_se3_sek_3_10_025
            name: Nordpool price
          - entity: sensor.ha1_huawei_battery_soc
            name: Battery SOC

  # --- HA1 – Live Energy Flow (picture-elements) ---------------------------
  - title: "HA1 – Energy Flow"
    path: ha1-energy-flow
    icon: mdi:solar-power-variant
    panel: true

    cards:
      - type: picture-elements
        title: "Live Energy Flow – Solar → Battery → House → EV → Grid"
        aspect_ratio: "3x2"
        image: /local/power.jpg

        elements:

          # Solar node
          - type: state-icon
            entity: sensor.ha1_power_solar_ac
            icon: mdi:solar-power-variant
            title: "Solar production (AC)"
            style:
              left: 12%
              top: 32%
              '--mdc-icon-size': 42px
              color: "#fdd835"
              filter: drop-shadow(0px 0px 8px rgba(253, 216, 53, 0.6))
              transform: translate(-50%, -50%)
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const s = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  return s > 0 ? 1 : 0.35;
                ]]]
            tap_action:
              action: more-info

          - type: state-label
            entity: sensor.ha1_power_solar_ac
            title: "Solar production (AC)"
            text: >-
              [[[ const s = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  return `Solar: ${(s / 1000).toFixed(2)} kW`; ]]]
            style:
              left: 12%
              top: 43%
              transform: translate(-50%, -50%)
              font-size: 14px
              font-weight: 600
              color: "#1b1b1b"
              background: rgba(255, 255, 255, 0.75)
              padding: 4px 8px
              border-radius: 10px
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25)

          # Battery node
          - type: state-icon
            entity: sensor.ha1_power_battery_net
            icon: mdi:battery-high
            title: "Battery (net power)"
            style:
              left: 32%
              top: 56%
              '--mdc-icon-size': 42px
              color: "#8bc34a"
              filter: drop-shadow(0px 0px 8px rgba(139, 195, 74, 0.6))
              transform: translate(-50%, -50%)
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const b = parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0;
                  return Math.min(1, Math.max(0.4, Math.abs(b) / 4000));
                ]]]
            tap_action:
              action: more-info

          - type: state-label
            entity: sensor.ha1_huawei_battery_soc
            title: "Battery state of charge"
            text: >-
              [[[ const p = parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0;
                  const soc = parseFloat(states['sensor.ha1_huawei_battery_soc']?.state) || 0;
                  const dir = p >= 0 ? 'Charging' : 'Discharging';
                  return `Battery ${soc.toFixed(0)}% – ${dir} ${(Math.abs(p) / 1000).toFixed(2)} kW`; ]]]
            style:
              left: 32%
              top: 67%
              transform: translate(-50%, -50%)
              font-size: 14px
              font-weight: 600
              color: "#1b1b1b"
              background: rgba(255, 255, 255, 0.78)
              padding: 4px 10px
              border-radius: 10px
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25)

          # House node
          - type: state-icon
            entity: sensor.ha1_power_house_total
            icon: mdi:home-lightning-bolt
            title: "House consumption"
            style:
              left: 55%
              top: 36%
              '--mdc-icon-size': 44px
              color: "#29b6f6"
              filter: drop-shadow(0px 0px 8px rgba(41, 182, 246, 0.6))
              transform: translate(-50%, -50%)
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const h = Math.max(0, parseFloat(states['sensor.ha1_power_house_total']?.state) || 0);
                  return Math.min(1, Math.max(0.4, h / 5000));
                ]]]
            tap_action:
              action: more-info

          - type: state-label
            entity: sensor.ha1_power_house_total
            title: "House consumption"
            text: >-
              [[[ const h = Math.max(0, parseFloat(states['sensor.ha1_power_house_total']?.state) || 0);
                  return `House: ${(h / 1000).toFixed(2)} kW`; ]]]
            style:
              left: 55%
              top: 47%
              transform: translate(-50%, -50%)
              font-size: 14px
              font-weight: 600
              color: "#1b1b1b"
              background: rgba(255, 255, 255, 0.78)
              padding: 4px 10px
              border-radius: 10px
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25)

          # EV node
          - type: state-icon
            entity: sensor.ha1_power_ev_charger
            icon: mdi:car-electric
            title: "EV charging power"
            style:
              left: 74%
              top: 64%
              '--mdc-icon-size': 42px
              color: "#5c6bc0"
              filter: drop-shadow(0px 0px 8px rgba(92, 107, 192, 0.6))
              transform: translate(-50%, -50%)
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const ev = Math.max(0, parseFloat(states['sensor.ha1_power_ev_charger']?.state) || 0);
                  return ev > 0 ? Math.min(1, 0.35 + ev / 6000) : 0.2;
                ]]]
            tap_action:
              action: more-info

          - type: state-label
            entity: sensor.ha1_power_ev_charger
            title: "EV charging power"
            text: >-
              [[[ const ev = Math.max(0, parseFloat(states['sensor.ha1_power_ev_charger']?.state) || 0);
                  return `EV: ${(ev / 1000).toFixed(2)} kW`; ]]]
            style:
              left: 74%
              top: 74%
              transform: translate(-50%, -50%)
              font-size: 14px
              font-weight: 600
              color: "#1b1b1b"
              background: rgba(255, 255, 255, 0.78)
              padding: 4px 10px
              border-radius: 10px
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25)

          # Grid node
          - type: state-icon
            entity: sensor.ha1_net_grid_power
            icon: mdi:transmission-tower
            title: "Grid import (+) / export (-)"
            style:
              left: 90%
              top: 32%
              '--mdc-icon-size': 42px
              color: "#ff9800"
              filter: drop-shadow(0px 0px 8px rgba(255, 152, 0, 0.6))
              transform: translate(-50%, -50%)
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const g = Math.abs(parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0);
                  return Math.min(1, Math.max(0.35, g / 5000));
                ]]]
            tap_action:
              action: more-info

          - type: state-label
            entity: sensor.ha1_net_grid_power
            title: "Grid import/export"
            text: >-
              [[[ const g = parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0;
                  const dir = g >= 0 ? 'Import' : 'Export';
                  return `Grid ${dir}: ${(Math.abs(g) / 1000).toFixed(2)} kW`; ]]]
            style:
              left: 90%
              top: 43%
              transform: translate(-50%, -50%)
              font-size: 14px
              font-weight: 600
              color: "#1b1b1b"
              background: rgba(255, 255, 255, 0.78)
              padding: 4px 10px
              border-radius: 10px
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25)

          # Solar -> Battery (charge)
          - type: icon
            icon: mdi:arrow-right-bold
            title: "Solar charging battery"
            style:
              left: 22%
              top: 46%
              transform: translate(-50%, -50%) rotate(10deg)
              '--mdc-icon-size': 40px
              color: "#66bb6a"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const solar = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  const battCharge = Math.max(0, parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0);
                  const flow = Math.min(solar, battCharge);
                  if (flow <= 0) return 0.12;
                  return Math.min(1, 0.25 + flow / 4000);
                ]]]
              filter: >-
                [[[
                  const solar = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  const battCharge = Math.max(0, parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0);
                  const flow = Math.min(solar, battCharge);
                  return flow > 0 ? 'drop-shadow(0 0 12px rgba(102, 187, 106, 0.6))' : 'none';
                ]]]

          # Solar -> House
          - type: icon
            icon: mdi:arrow-right-bold
            title: "Solar feeding the house"
            style:
              left: 34%
              top: 28%
              transform: translate(-50%, -50%) rotate(2deg)
              '--mdc-icon-size': 36px
              color: "#ffeb3b"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const solar = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  return solar > 0 ? Math.min(1, 0.25 + solar / 5000) : 0.12;
                ]]]
              filter: >-
                [[[
                  const solar = Math.max(0, parseFloat(states['sensor.ha1_power_solar_ac']?.state) || 0);
                  return solar > 0 ? 'drop-shadow(0 0 10px rgba(255, 235, 59, 0.65))' : 'none';
                ]]]

          # Battery -> House (discharge)
          - type: icon
            icon: mdi:arrow-right-bold
            title: "Battery discharging to house"
            style:
              left: 44%
              top: 48%
              transform: translate(-50%, -50%) rotate(-8deg)
              '--mdc-icon-size': 38px
              color: "#03a9f4"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const batt = parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0;
                  const discharge = batt < 0 ? -batt : 0;
                  if (discharge <= 0) return 0.1;
                  return Math.min(1, 0.25 + discharge / 4000);
                ]]]
              filter: >-
                [[[
                  const batt = parseFloat(states['sensor.ha1_power_battery_net']?.state) || 0;
                  const discharge = batt < 0 ? -batt : 0;
                  return discharge > 0 ? 'drop-shadow(0 0 12px rgba(3, 169, 244, 0.6))' : 'none';
                ]]]

          # House -> EV
          - type: icon
            icon: mdi:arrow-right-bold
            title: "Power to EV charger"
            style:
              left: 64%
              top: 52%
              transform: translate(-50%, -50%) rotate(20deg)
              '--mdc-icon-size': 38px
              color: "#5c6bc0"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const ev = Math.max(0, parseFloat(states['sensor.ha1_power_ev_charger']?.state) || 0);
                  return ev > 0 ? Math.min(1, 0.25 + ev / 7000) : 0.1;
                ]]]
              filter: >-
                [[[
                  const ev = Math.max(0, parseFloat(states['sensor.ha1_power_ev_charger']?.state) || 0);
                  return ev > 0 ? 'drop-shadow(0 0 12px rgba(92, 107, 192, 0.55))' : 'none';
                ]]]

          # Grid -> House (import)
          - type: icon
            icon: mdi:arrow-left-bold
            title: "Grid import"
            style:
              left: 82%
              top: 32%
              transform: translate(-50%, -50%)
              '--mdc-icon-size': 38px
              color: "#29b6f6"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const g = parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0;
                  const imp = g > 0 ? g : 0;
                  return imp > 0 ? Math.min(1, 0.25 + imp / 5000) : 0.08;
                ]]]
              filter: >-
                [[[
                  const g = parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0;
                  return g > 0 ? 'drop-shadow(0 0 12px rgba(41, 182, 246, 0.6))' : 'none';
                ]]]

          # House -> Grid (export)
          - type: icon
            icon: mdi:arrow-right-bold
            title: "Grid export"
            style:
              left: 82%
              top: 44%
              transform: translate(-50%, -50%)
              '--mdc-icon-size': 38px
              color: "#66bb6a"
              transition: opacity 0.6s ease, filter 0.6s ease
              opacity: >-
                [[[
                  const g = parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0;
                  const exp = g < 0 ? -g : 0;
                  return exp > 0 ? Math.min(1, 0.25 + exp / 5000) : 0.08;
                ]]]
              filter: >-
                [[[
                  const g = parseFloat(states['sensor.ha1_net_grid_power']?.state) || 0;
                  const exp = g < 0 ? -g : 0;
                  return exp > 0 ? 'drop-shadow(0 0 12px rgba(102, 187, 106, 0.6))' : 'none';
                ]]]
