# /config/packages/energy_flow_states.yaml
#
# Flow helpers for visual energy map (â˜€ â†’ ðŸ”‹ â†’ ðŸ  / ðŸŒ / ðŸš—)
# Byggd fÃ¶r att Ã¥teranvÃ¤ndas i bÃ¥de enkel och "fancy" dashboard.

template:
  - binary_sensor:
      # -------------------------------------------------------------
      # SOLAR â†’ BATTERY (PV producerar och det finns solÃ¶verskott)
      # -------------------------------------------------------------
      - name: "Flow â€“ Solar to Battery"
        unique_id: flow_solar_to_battery
        device_class: power
        state: >-
          {% set pv = states('sensor.inverter_input_power') | float(0) %}
          {% set surplus = is_state('binary_sensor.battery_solar_surplus_now', 'on') %}
          {% set soc = states('sensor.battery_state_of_capacity') | float(100) %}
          {{ pv > 100 and surplus and soc < 100 }}

      # -------------------------------------------------------------
      # SOLAR â†’ HOUSE (PV > 0 men inget solÃ¶verskott = allt gÃ¥r till lasten)
      # -------------------------------------------------------------
      - name: "Flow â€“ Solar to House"
        unique_id: flow_solar_to_house
        device_class: power
        state: >-
          {% set pv = states('sensor.inverter_input_power') | float(0) %}
          {% set surplus = is_state('binary_sensor.battery_solar_surplus_now', 'on') %}
          {{ pv > 100 and not surplus }}

      # -------------------------------------------------------------
      # GRID â†’ HOUSE (negativ import_export_power = import frÃ¥n nÃ¤tet)
      # -------------------------------------------------------------
      - name: "Flow â€“ Grid to House"
        unique_id: flow_grid_to_house
        device_class: power
        state: >-
          {% set flow = states('sensor.import_export_power') | float(0) %}
          {{ flow < -0.1 }}

      # -------------------------------------------------------------
      # GRID â†’ BATTERY (nÃ¤timport samtidigt som logiken sÃ¤ger att
      # vi fÃ¥r ladda batteriet frÃ¥n nÃ¤tet)
      # -------------------------------------------------------------
      - name: "Flow â€“ Grid to Battery"
        unique_id: flow_grid_to_battery
        device_class: power
        state: >-
          {% set flow = states('sensor.import_export_power') | float(0) %}
          {% set can_charge = is_state('binary_sensor.battery_can_grid_charge_now', 'on') %}
          {{ can_charge and flow < -0.1 }}

      # -------------------------------------------------------------
      # BATTERY â†’ GRID (export + logiken tycker vi ska discha)
      # -------------------------------------------------------------
      - name: "Flow â€“ Battery to Grid"
        unique_id: flow_battery_to_grid
        device_class: power
        state: >-
          {% set batt_kw = states('sensor.huawei_battery_import_export') | float(0) %}
          {% set flow = states('sensor.import_export_power') | float(0) %}
          {{ batt_kw < -0.2 and flow > 0.1 }}

      # -------------------------------------------------------------
      # BATTERY â†’ HOUSE (discharge aktiv men ingen tydlig export)
      # -------------------------------------------------------------
      - name: "Flow â€“ Battery to House"
        unique_id: flow_battery_to_house
        device_class: power
        state: >-
          {% set batt_kw = states('sensor.huawei_battery_import_export') | float(0) %}
          {{ batt_kw < -0.2 }}
