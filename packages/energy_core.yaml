# energy_core.yaml – Energy Core – HomeAssistant 1.2
#
# Uses INTEGRATION entities (do NOT edit these IDs here):
#   - sensor.inverter_input_power           (PV input, W)
#   - sensor.battery_state_of_capacity      (Battery SOC, %)
#   - sensor.battery_charge_discharge_power (Battery charge/discharge, kW)
#   - sensor.inverter_active_power          (Inverter active power, kW)
#   - sensor.power_meter_active_power       (Grid import/export, W)
#   - sensor.ehxdyl83_power                 (Easee charger power, kW)
#   - sensor.id4pro_battery_level           (ID.4 battery level, %)
#   - sensor.id4pro_charging_power          (ID.4 charging power, kW)
#
# Defines EXTRA "ha1_*" entities for UI & logic (safe to use/edit elsewhere):
#   - sensor.ha1_solar_power
#   - sensor.ha1_battery_soc
#   - sensor.ha1_battery_power
#   - sensor.ha1_house_power
#   - sensor.ha1_grid_power
#   - sensor.ha1_ev_charger_power
#   - sensor.ha1_ev_id4_battery_level
#   - sensor.ha1_ev_id4_charging_power
#   - sensor.ha1_flow_solar_total
#   - sensor.ha1_flow_battery_discharge
#   - sensor.ha1_flow_battery_charge
#   - sensor.ha1_flow_grid_import
#   - sensor.ha1_flow_grid_export
#   - sensor.ha1_flow_house_to_ev
#   - sensor.ha1_flow_ev_to_id4
#   - sensor.ha1_flow_solar_to_house_ac
#   - sensor.ha1_flow_solar_to_grid_ac
#   - sensor.ha1_flow_battery_to_house_ac
#   - sensor.ha1_flow_battery_to_grid_ac
#   - sensor.ha1_flow_battery_to_house       (GUI alias)
#   - sensor.ha1_flow_solar_to_battery       (GUI alias)
#   - sensor.ha1_flow_solar_to_house         (GUI alias)
#
# Assumptions (adjust later if needed):
#   - sensor.battery_charge_discharge_power:
#       > 0  => battery DISCHARGING (to house/grid)
#       < 0  => battery CHARGING (from solar/grid)
#   - sensor.power_meter_active_power:
#       > 0  => IMPORT from grid
#       < 0  => EXPORT to grid
#   - House load is approximated as:
#         P_house = P_inverter_active (AC) + P_grid
#     which matches the typical Huawei "Load" calculation.
#

template:
  - sensor:

      ###############################################################
      # Canonical alias sensors – stable interface for GUI & logic
      ###############################################################

      - name: "HA1 Solar Power"
        unique_id: ha1_solar_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power
        state: >
          {{ states('sensor.inverter_input_power') | float(0) }}

      - name: "HA1 Battery SOC"
        unique_id: ha1_battery_soc
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        icon: mdi:battery-high
        state: >
          {{ states('sensor.battery_state_of_capacity') | float(0) }}

      - name: "HA1 Battery Power"
        unique_id: ha1_battery_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:battery-charging
        # Assumption: positive = discharging, negative = charging
        state: >
          {{ (states('sensor.battery_charge_discharge_power') | float(0)) * 1000 }}

      - name: "HA1 Grid Power"
        unique_id: ha1_grid_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:transmission-tower
        # Assumption: positive = IMPORT, negative = EXPORT
        state: >
          {{ states('sensor.power_meter_active_power') | float(0) }}

      - name: "HA1 House Power"
        unique_id: ha1_house_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:home-lightning-bolt
        # House ≈ inverter AC active power (W) + grid power (W)
        # Night: inverter ≈ 0, grid import = house load
        # Day: inverter + (±grid) = house
        state: >
          {% set inv  = (states('sensor.inverter_active_power') | float(0)) * 1000 %}
          {% set grid = states('sensor.power_meter_active_power') | float(0) %}
          {{ (inv + grid) | round(0) }}

      - name: "HA1 EV Charger Power"
        unique_id: ha1_ev_charger_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:ev-station
        state: >
          {{ (states('sensor.ehxdyl83_power') | float(0)) * 1000 }}

      - name: "HA1 EV ID4 Battery Level"
        unique_id: ha1_ev_id4_battery_level
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        icon: mdi:car-electric
        state: >
          {{ states('sensor.id4pro_battery_level') | float(0) }}

      - name: "HA1 EV ID4 Charging Power"
        unique_id: ha1_ev_id4_charging_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:ev-station
        state: >
          {{ (states('sensor.id4pro_charging_power') | float(0)) * 1000 }}

      ###############################################################
      # Flow sensors – magnitude of *raw* flows
      ###############################################################

      - name: "HA1 Flow – Solar Total"
        unique_id: ha1_flow_solar_total
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power
        state: >
          {% set p = states('sensor.inverter_input_power') | float(0) %}
          {{ [p, 0] | max }}

      - name: "HA1 Flow – Battery Discharge"
        unique_id: ha1_flow_battery_discharge
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:battery-arrow-down
        state: >
          {% set p = (states('sensor.battery_charge_discharge_power') | float(0)) * 1000 %}
          {% if p > 0 %}
            {{ p }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow – Battery Charge"
        unique_id: ha1_flow_battery_charge
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:battery-arrow-up
        state: >
          {% set p = (states('sensor.battery_charge_discharge_power') | float(0)) * 1000 %}
          {% if p < 0 %}
            {{ -p }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow – Grid Import"
        unique_id: ha1_flow_grid_import
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:transmission-tower-import
        state: >
          {% set p = states('sensor.power_meter_active_power') | float(0) %}
          {% if p > 0 %}
            {{ p }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow – Grid Export"
        unique_id: ha1_flow_grid_export
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:transmission-tower-export
        state: >
          {% set p = states('sensor.power_meter_active_power') | float(0) %}
          {% if p < 0 %}
            {{ -p }}
          {% else %}
            0
          {% endif %}

      - name: "HA1 Flow – House to EV"
        unique_id: ha1_flow_house_to_ev
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:arrow-right-bold
        # For now: EV charger power = flow from house/bus to charger
        state: >
          {{ states('sensor.ha1_ev_charger_power') | float(0) }}

      - name: "HA1 Flow – EV Charger to ID4"
        unique_id: ha1_flow_ev_to_id4
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:arrow-right-bold
        # For now: ID4 AC charging power
        state: >
          {{ states('sensor.ha1_ev_id4_charging_power') | float(0) }}

      ###############################################################
      # Derived AC-side splits: Solar/Battery → House/Grid
      ###############################################################

      # Solar → House (AC side)
      - name: "HA1 Flow – Solar to House (AC)"
        unique_id: ha1_flow_solar_to_house_ac
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power
        state: >
          {% set solar = states('sensor.ha1_solar_power') | float(0) %}
          {% set house = states('sensor.ha1_house_power') | float(0) %}
          {{ [solar, house] | min }}

      # Solar → Grid (AC side)
      - name: "HA1 Flow – Solar to Grid (AC)"
        unique_id: ha1_flow_solar_to_grid_ac
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power
        state: >
          {% set solar = states('sensor.ha1_solar_power')        | float(0) %}
          {% set house = states('sensor.ha1_house_power')        | float(0) %}
          {% set g_imp = states('sensor.ha1_flow_grid_import')   | float(0) %}
          {% set g_exp = states('sensor.ha1_flow_grid_export')   | float(0) %}
          {# Only export case is relevant for solar->grid #}
          {% set g_exp_use = g_exp %}
          {# Solar that remains after covering house #}
          {% set solar_surplus = [solar - house, 0] | max %}
          {# But cannot exceed actual grid export #}
          {{ [solar_surplus, g_exp_use] | min }}

      # Battery → House (AC side)
      - name: "HA1 Flow – Battery to House (AC)"
        unique_id: ha1_flow_battery_to_house_ac
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:battery-arrow-down
        state: >
          {% set solar_to_house = states('sensor.ha1_flow_solar_to_house_ac') | float(0) %}
          {% set house         = states('sensor.ha1_house_power')            | float(0) %}
          {% set batt_dis      = states('sensor.ha1_flow_battery_discharge') | float(0) %}
          {# House still needing power after solar #}
          {% set house_after_solar = [house - solar_to_house, 0] | max %}
          {{ [batt_dis, house_after_solar] | min }}

      # Battery → Grid (AC side)
      - name: "HA1 Flow – Battery to Grid (AC)"
        unique_id: ha1_flow_battery_to_grid_ac
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:battery-arrow-up
        state: >
          {% set solar_to_house = states('sensor.ha1_flow_solar_to_house_ac') | float(0) %}
          {% set solar_to_grid  = states('sensor.ha1_flow_solar_to_grid_ac')  | float(0) %}
          {% set house          = states('sensor.ha1_house_power')            | float(0) %}
          {% set batt_dis       = states('sensor.ha1_flow_battery_discharge') | float(0) %}
          {% set g_exp          = states('sensor.ha1_flow_grid_export')       | float(0) %}

          {# 1. How much of the house is left after solar? #}
          {% set house_after_solar = [house - solar_to_house, 0] | max %}

          {# 2. Battery that goes to house #}
          {% set battery_to_house = [batt_dis, house_after_solar] | min %}

          {# 3. Battery discharge remaining after house is covered #}
          {% set batt_rem = [batt_dis - battery_to_house, 0] | max %}

          {# 4. Export left after solar export has been accounted for #}
          {% set export_remaining = [g_exp - solar_to_grid, 0] | max %}

          {# 5. Battery to grid is whatever part of remaining battery discharge
              can actually be seen as export beyond solar's contribution #}
          {{ [batt_rem, export_remaining] | min }}

      ###############################################################
      # GUI-friendly aliases for lines/arrows
      ###############################################################

      # Battery → House arrow: use new AC-side split
      - name: "HA1 Flow – Battery to House"
        unique_id: ha1_flow_battery_to_house
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:arrow-down-bold
        state: >
          {{ states('sensor.ha1_flow_battery_to_house_ac') | float(0) }}

      # Solar → Battery arrow: use battery charge magnitude (DC-side)
      - name: "HA1 Flow – Solar to Battery"
        unique_id: ha1_flow_solar_to_battery
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:arrow-right-bold
        state: >
          {{ states('sensor.ha1_flow_battery_charge') | float(0) }}

      # Solar → House arrow: use new AC-side Solar → House
      - name: "HA1 Flow – Solar to House"
        unique_id: ha1_flow_solar_to_house
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:arrow-down-bold
        state: >
          {{ states('sensor.ha1_flow_solar_to_house_ac') | float(0) }}
