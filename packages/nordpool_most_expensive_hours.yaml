###############################################################################
# Package: nordpool_most_expensive_hours.yaml
# Purpose:
#   - Calculate the sequential most expensive Nordpool hours for tomorrow
#   - Store start/end helpers that other automations can reference to avoid
#     running during the costly window
###############################################################################

sensor:
  - platform: template
    sensors:
      expensive_hours_energy_tomorrow:
        device_class: timestamp
        friendly_name: Expensive sequential electricity hours
        # Example configuration calculates eight expensive hours for the full next day (00:00â€“24:00)
        # CHANGE-ME: numberOfSequentialHours = Number of sequential expensive hours we are looking for
        # CHANGE-ME: lastHour = Final hour to search (start of final hour, e.g. 23 => 23:00-24:00)
        # CHANGE-ME: firstHour = First hour to search from
        # CHANGE-ME: Update the Nordpool entity id below (TWO ENTRIES): sensor.nordpool_kwh_se3_sek_3_10_025
        value_template: >
          {%- set numberOfSequentialHours = 8 -%}
          {%- set lastHour = 23 -%}
          {%- set firstHour = 0 -%}
          {%- if state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'tomorrow_valid') == true -%}
            {%- set ns = namespace(counter=0, list=[], expensiveHour=today_at("00:00") + timedelta(hours=24), expensivePrice=0.00) -%}
            {%- for i in range(firstHour + numberOfSequentialHours, lastHour + 1) -%}
              {%- set ns.counter = 0.0 -%}
              {%- for j in range(i - numberOfSequentialHours, i) -%}
                {%- set ns.counter = ns.counter + state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'tomorrow')[j] -%}
              {%- endfor -%}
              {%- set ns.list = ns.list + [ns.counter] -%}
              {%- if ns.counter > ns.expensivePrice -%}
                {%- set ns.expensivePrice = ns.counter -%}
                {%- set ns.expensiveHour = today_at("00:00") + timedelta(hours=(24 + i - numberOfSequentialHours)) -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.expensiveHour }}
            {%- set ns.expensivePrice = ns.expensivePrice / numberOfSequentialHours -%}
          {%- endif -%}

# Helpers to keep the start / end time
input_datetime:
  device_exp_start_time:
    name: Device Exp Start Time
    has_time: true
    has_date: false
  device_exp_end_time:
    name: Device Exp End Time
    has_time: true
    has_date: false

# Automations
automation:
  - id: '1663398488822'
    alias: 'Set Exp device/end start time'
    description: ''
    trigger:
      - platform: time
        at: '23:15:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.expensive_hours_energy_tomorrow
            state: unknown
    action:
      - service: input_datetime.set_datetime
        data:
          time: "{{ as_timestamp(states('sensor.expensive_hours_energy_tomorrow')) | timestamp_custom('%H:%M') }}"
        target:
          entity_id: input_datetime.device_exp_start_time
      - service: input_datetime.set_datetime
        data:
          # CHANGE-ME: 8 (3600*8) is the number of sequential expensive hours we are looking for
          time: "{{ (as_timestamp(states('sensor.expensive_hours_energy_tomorrow')) + (3600 * 8)) | timestamp_custom('%H:%M') }}"
        target:
          entity_id: input_datetime.device_exp_end_time
    mode: single
